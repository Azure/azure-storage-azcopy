parameters:
  - name: build_name
    type: string
  - name: storage_account_name
    type: string
  - name: container_name
    type: string

steps:
  - task: Bash@3
    displayName: 'Install Azure CLI'
    inputs:
      targetType: 'inline'
      script: |
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

  # # azcli login
  # - script: |
  #     az login --identity --username 96122e98-2015-4cb5-a90b-d421a2d64f21
  #   displayName: 'Azure CLI login'

  - task: AzureCLI@2
    displayName: 'Run Scenarios'
    inputs:
      azureSubscription: 'AzTest-SP'
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        AZCOPY_AUTO_LOGIN_TYPE=AzCLI $(Build.ArtifactStagingDirectory)/drop/${{ parameters.build_name }} make "https://${{ parameters.container_name }}.blob.core.windows.net/${{ parameters.storage_account_name }}"
        echo "Hello, Azure!" > myfile.txt
        AZCOPY_AUTO_LOGIN_TYPE=AzCLI $(Build.ArtifactStagingDirectory)/drop/${{ parameters.build_name }} cp myfile.txt "https://${{ parameters.storage_account_name }}.blob.core.windows.net/${{ parameters.container_name }}"
        AZCOPY_AUTO_LOGIN_TYPE=AzCLI $(Build.ArtifactStagingDirectory)/drop/${{ parameters.build_name }} cp "https://${{ parameters.storage_account_name }}.blob.core.windows.net/${{ parameters.container_name }}/myfile.txt" --from-to=BlobPipe --check-md5 FailIfDifferentOrMissing > filename