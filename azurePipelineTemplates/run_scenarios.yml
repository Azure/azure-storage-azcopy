parameters:
  - name: storage_account_name
    type: string
  - name: container_name
    type: string

steps:
  - task: AzureCLI@2
    displayName: "Run Scenarios"
    inputs:
      azureSubscription: azcopyTestScenarios
      addSpnToEnvironment: true
      scriptType: pscore
      scriptLocation: inlineScript
      inlineScript: |
        # Print "Building executable"
        Write-Output "Building executable"
        
        # Set platform-specific environment variables and tags
        $tags = ""
        $suffix = ""
        $build_name = ""
        $display_name = ""
        if ($IsWindows) {
          $env:GOOS = "windows"
          $env:GOARCH = "amd64"
          $build_name = "azcopy_windows_amd64.exe"
          $env:AZCOPY_AUTO_LOGIN_TYPE="AzCLI"
        } elseif ($IsLinux) {
          $env:GOOS = "linux"
          $env:GOARCH = "amd64"
          $build_name = "azcopy_linux_amd64"
        } elseif ($IsMacOS) {
          $env:GOOS = "darwin"
          $env:GOARCH = "amd64"
          $env:CGO_ENABLED = "1"
          $build_name = "azcopy_darwin_amd64"
        } else {
          Write-Error "Unsupported operating system"
          exit 1
        }

        $env:AZCOPY_AUTO_LOGIN_TYPE="AzCLI"

        go build -cover -o $build_name

        # Check if the executable was created
        if (-Not (Test-Path "./$build_name")) {
            Write-Error "Executable not found: $build_name"
            exit 1
        }
        Write-Output "Executable built successfully: $build_name"

        ######################################################## Scenario 1 ########################################################

        # Right now we dont have this fix available in the older version of AzCopy. So, we are using the latest version of AzCopy to run the scenarios.
        # We will update this workaround once the fix is available in the older version of AzCopy.

        & "./$build_name" "make" "https://${{ parameters.storage_account_name }}.blob.core.windows.net/${{ parameters.container_name }}"
        echo "Hello, Azure!" > myfile.txt
        & "./$build_name" "cp" "myfile.txt" "https://${{ parameters.storage_account_name }}.blob.core.windows.net/${{ parameters.container_name }}"
        & "./$build_name" "cp" "https://${{ parameters.storage_account_name }}.blob.core.windows.net/${{ parameters.container_name }}/myfile.txt" "--from-to=BlobPipe" "--check-md5" "FailIfDifferentOrMissing" > filename
        & "./$build_name" "rm" "https://${{ parameters.storage_account_name }}.blob.core.windows.net/${{ parameters.container_name }}" --recursive

        if ($LASTEXITCODE -eq 0) {
            Write-Output "AzCopy command succeeded."
        } else {
            Write-Error "AzCopy command failed with exit code $LASTEXITCODE."
        }

        ######################################################## Scenario 2 ########################################################

        # Test copying from Object Replication Policy source container to destination container
        # Assign an object replication policy to a storage account. 
        # Perform azcopy copy opertaion to copy the blob to another container.

        echo "Hello, Azure!" > myfile.txt
        & "./$build_name" "cp" "myfile.txt" "https://azcopyorpsrcaccount.blob.core.windows.net/srcorpcontainer"
        & "./$build_name" "cp" "https://azcopyorpsrcaccount.blob.core.windows.net/srcorpcontainer" "https://azcopyorpdestaccount.blob.core.windows.net/testcontainer" --recursive

        if ($LASTEXITCODE -eq 0) {
            Write-Output "AzCopy command succeeded."
        } else {
            Write-Error "AzCopy command failed with exit code $LASTEXITCODE."
        }

