parameters:
  - name: storage_account_name
    type: string
  - name: container_name
    type: string
  - name: goos
    type: string
  - name: goarch
    type: string
  - name: cgo_enabled
    type: string
  - name: build_name
    type: string

steps:
  - task: AzureCLI@2
    inputs:
      azureSubscription: azcopytestworkloadidentity
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        set -e
        echo "========== Building executable =========="

        go build -cover -o "${{ parameters.build_name }}"
        if [ ! -f "./${{ parameters.build_name }}" ]; then
          echo "Error: Executable not found: ${{ parameters.build_name }}"
          exit 1
        fi
        echo "Executable built successfully: ${{ parameters.build_name }}"

        ########################################################
        # Scenario 1: Blob â†’ Pipe
        ########################################################
        echo "========== Scenario 1: BlobToPipe =========="

        echo "Cleaning up Scenario 1..."
        AZCOPY_AUTO_LOGIN_TYPE=AzCLI "./${{ parameters.build_name }}" rm "https://${{ parameters.storage_account_name }}.blob.core.windows.net/${{ parameters.container_name }}/myfile.txt"

        echo "Creating a test file and uploading it..."
        echo "Hello, Azure!" > myfile.txt
        AZCOPY_AUTO_LOGIN_TYPE=AzCLI "./${{ parameters.build_name }}" cp myfile.txt "https://${{ parameters.storage_account_name }}.blob.core.windows.net/${{ parameters.container_name }}"

        echo "Copying the file back using BlobPipe..."
        AZCOPY_AUTO_LOGIN_TYPE=AzCLI "./${{ parameters.build_name }}" cp \
          "https://${{ parameters.storage_account_name }}.blob.core.windows.net/${{ parameters.container_name }}/myfile.txt" \
          --from-to=BlobPipe --check-md5 FailIfDifferentOrMissing > filename

        scenario1_exit_code=$?
        if [ $scenario1_exit_code -eq 0 ]; then
          echo "Scenario 1 executed successfully."
        else
          echo "Scenario 1 failed with exit code $scenario1_exit_code"
        fi
      displayName: "Run Scenarios"
    env:
      GOOS: ${{ parameters.goos }}
      GOARCH: ${{ parameters.goarch }}
      CGO_ENABLED: ${{ parameters.cgo_enabled }}
      NEW_E2E_ENVIRONMENT: "AzurePipeline"
