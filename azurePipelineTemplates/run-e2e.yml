parameters:
  - name: name
    type: string
  - name: test_cli_param
    type: string

jobs:
  - job: ${{ parameters.name }}
    timeoutInMinutes: 360
    # Creating strategies for GOOS: Windows Server 2019 /macOS X Mojave 10.15/Ubuntu 20.04
    strategy:
      matrix:
        Ubuntu-20:
          imageName: 'ubuntu-latest'
          build_name: 'azcopy_linux_amd64'
          display_name: "Linux"
        Windows:
          imageName: 'windows-latest'
          build_name: 'azcopy_windows_amd64.exe'
          display_name: "Windows"
          type: 'windows'
        MacOS:
          imageName: 'macos-latest'
          build_name: 'azcopy_darwin_amd64'
          display_name: "MacOS"
    pool:
      vmImage: $(imageName)
    steps:
      - task: PowerShell@2
        inputs:
          targetType: 'inline'
          script: 'Install-Module -Name Az.Accounts -Scope CurrentUser -Repository PSGallery -AllowClobber -Force'
          pwsh: 'true'
        displayName: 'Install Powershell Az Module'
      - task: GoTool@0
        inputs:
          version: $(AZCOPY_GOLANG_VERSION_COVERAGE)
      - script: |
          go install github.com/jstemmer/go-junit-report@v0.9.1
          go install github.com/axw/gocov/gocov@v1.1.0
          go install github.com/AlekSi/gocov-xml@v1.0.0
          go install github.com/matm/gocov-html@v0.0.0-20200509184451-71874e2e203b
        displayName: 'Installing dependencies'
      - bash: |
          echo "##vso[task.setvariable variable=CGO_ENABLED]0"
        displayName: 'Set CGO_ENABLED for Windows'
        condition: eq(variables.type, 'windows')
      - bash: |
          npm install -g azurite
          mkdir azurite
          azurite --silent --location azurite --debug azurite\debug.log &
        displayName: 'Install and Run Azurite'
      # Running E2E Tests on AMD64
      - task: AzureCLI@2
        inputs:
          azureSubscription: azcopytestworkloadidentity
          addSpnToEnvironment: true
          scriptType: pscore
          scriptLocation: inlineScript
          inlineScript: |
            # Create coverage directory
            if (-Not (Test-Path -Path "./coverage")) {
              New-Item -Path "./coverage" -ItemType Directory
            }
            
            # Create log directory
            if (-Not (Test-Path -Path "${env:AZCOPY_E2E_LOG_OUTPUT}")) {
              New-Item -Path "${env:AZCOPY_E2E_LOG_OUTPUT}" -ItemType Directory
            }
            
            # Print "Building executable"
            Write-Output "Building executable"
            
            # Set platform-specific environment variables and tags
            $tags = ""
            $suffix = ""
            $build_name = ""
            $display_name = ""
            if ($IsWindows) {
              $env:GOOS = "windows"
              $env:GOARCH = "amd64"
              $suffix = ".exe"
              $build_name = "azcopy_windows_amd64.exe"
              $display_name = "Windows"
            } elseif ($IsLinux) {
              $env:GOOS = "linux"
              $env:GOARCH = "amd64"
              $tags = "netgo"
              $build_name = "azcopy_linux_amd64"
              $display_name = "Linux"
            } elseif ($IsMacOS) {
              $env:GOOS = "darwin"
              $env:GOARCH = "amd64"
              $env:CGO_ENABLED = "1"
              $build_name = "azcopy_darwin_amd64"
              $display_name = "MacOS"
            } else {
              Write-Error "Unsupported operating system"
              exit 1
            }
            
            # Build the Go program
            if ($tags -ne "") {
              go build -cover -tags $tags -o $build_name
            } else {
              go build -cover -o $build_name
            }
            
            # Print "Running tests"
            Write-Output "Running tests"
            
            # Run tests and pipe output to test.txt
            go test -timeout=2h -v ${{ parameters.test_cli_param }} ./e2etest | Tee-Object -FilePath test.txt
            
            # Save the exit code from the previous command
            $exitCode = $LASTEXITCODE
            
            # Print the contents of test.txt
            # Get-Content test.txt
            
            # Print "Generating junit report"
            Write-Output "Generating junit report"
            
            # Pipe info in test.txt to go-junit-report and save output to report.xml
            Get-Content test.txt | & "$(go env GOPATH)/bin/go-junit-report" > "${display_name}_report.xml"
            
            # Print "Formatting coverage directory to legacy txt format"
            Write-Output "Formatting coverage directory to legacy txt format"
            
            # Format coverage data to text format
            go tool covdata textfmt -i=coverage -o "${display_name}_coverage.txt"
            
            # Print "Formatting coverage to json format"
            Write-Output "Formatting coverage to json format"
            
            # Convert coverage.txt to coverage.json
            & "$(go env GOPATH)/bin/gocov$suffix" convert "${display_name}_coverage.txt" > "${display_name}_coverage.json"
            
            # Print "Formatting coverage to xml format"
            Write-Output "Formatting coverage to xml format"
            
            # Convert coverage.json to coverage.xml
            Get-Content "${display_name}_coverage.json" | & "$(go env GOPATH)/bin/gocov-xml$suffix" > "${display_name}_coverage.xml"
            
            # Return the exit code from step 5
            exit $exitCode
        env:
          AZCOPY_E2E_ACCOUNT_KEY: $(AZCOPY_E2E_ACCOUNT_KEY)
          AZCOPY_E2E_ACCOUNT_NAME: $(AZCOPY_E2E_ACCOUNT_NAME)
          AZCOPY_E2E_ACCOUNT_KEY_HNS: $(AZCOPY_E2E_ACCOUNT_KEY_HNS)
          AZCOPY_E2E_ACCOUNT_NAME_HNS: $(AZCOPY_E2E_ACCOUNT_NAME_HNS)
          AZCOPY_E2E_CLASSIC_ACCOUNT_NAME: $(AZCOPY_E2E_CLASSIC_ACCOUNT_NAME)
          AZCOPY_E2E_CLASSIC_ACCOUNT_KEY: $(AZCOPY_E2E_CLASSIC_ACCOUNT_KEY)
          AZCOPY_E2E_LOG_OUTPUT: '$(System.DefaultWorkingDirectory)/logs'
          AZCOPY_E2E_OAUTH_MANAGED_DISK_CONFIG: $(AZCOPY_E2E_OAUTH_MANAGED_DISK_CONFIG)
          AZCOPY_E2E_OAUTH_MANAGED_DISK_SNAPSHOT_CONFIG: $(AZCOPY_E2E_OAUTH_MANAGED_DISK_SNAPSHOT_CONFIG)
          AZCOPY_E2E_STD_MANAGED_DISK_CONFIG: $(AZCOPY_E2E_STD_MANAGED_DISK_CONFIG)
          AZCOPY_E2E_STD_MANAGED_DISK_SNAPSHOT_CONFIG: $(AZCOPY_E2E_STD_MANAGED_DISK_SNAPSHOT_CONFIG)
          CPK_ENCRYPTION_KEY: $(CPK_ENCRYPTION_KEY)
          CPK_ENCRYPTION_KEY_SHA256: $(CPK_ENCRYPTION_KEY_SHA256)
          AZCOPY_E2E_EXECUTABLE_PATH: $(System.DefaultWorkingDirectory)/$(build_name)
          GOCOVERDIR: '$(System.DefaultWorkingDirectory)/coverage'
          NEW_E2E_SUBSCRIPTION_ID: $(AZCOPY_NEW_E2E_SUBSCRIPTION_ID)
          NEW_E2E_AZCOPY_PATH: $(System.DefaultWorkingDirectory)/$(build_name)
          NEW_E2E_ENVIRONMENT: "AzurePipeline"
          RUN_NFS_TESTSUITE: "FALSE"
          #NEW_E2E_PREMIUM_FILESHARE_ACCOUNT_KEY: $(PREMIUM_FILESHARE_ACCOUNT_KEY)
          #NEW_E2E_PREMIUM_FILESHARE_ACCOUNT_NAME: $(PREMIUM_FILESHARE_ACCOUNT_NAME)
        displayName: 'E2E Test $(display_name) - AMD64 with Workload Identity'

      - task: PublishBuildArtifacts@1
        displayName: 'Publish logs'
        condition: succeededOrFailed()
        inputs:
          pathToPublish: '$(System.DefaultWorkingDirectory)/logs'
          artifactName: logs

      - task: PublishTestResults@2
        condition: succeededOrFailed()
        inputs:
          testRunner: JUnit
          testResultsFiles: $(System.DefaultWorkingDirectory)/**/$(display_name)_report.xml
          testRunTitle: 'Go on $(display_name)'

      - task: PublishCodeCoverageResults@1
        condition: succeededOrFailed()
        inputs:
          codeCoverageTool: Cobertura
          summaryFileLocation: $(System.DefaultWorkingDirectory)/**/$(display_name)_coverage.xml
          additionalCodeCoverageFiles: $(System.DefaultWorkingDirectory)/**/$(display_name)_coverage.html

  - job: ${{ parameters.name }}_nfs
    timeoutInMinutes: 360
    #condition: eq(parameters.name, 'New_E2E')
    strategy:
      matrix:
        Ubutun-22:
          vmImage: 'Ubuntu-22.04'
          agentName: "azcopy-nfs-vm"
          build_name: 'azcopy_linux_amd64'
          display_name: "Linux"
    pool:
      name: "azcopy-nfs-pool"

    steps:

      - task: Bash@3
        displayName: 'Install Azure CLI'
        inputs:
          targetType: 'inline'
          script: |
            curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - task: GoTool@0
        inputs:
          version: $(AZCOPY_GOLANG_VERSION_COVERAGE)

      - script: |
          go install github.com/jstemmer/go-junit-report@v0.9.1
          go install github.com/axw/gocov/gocov@v1.1.0
          go install github.com/AlekSi/gocov-xml@v1.0.0
          go install github.com/matm/gocov-html@v0.0.0-20200509184451-71874e2e203b
        displayName: 'Installing dependencies'

      - bash: |
          echo "##vso[task.setvariable variable=CGO_ENABLED]0"
        displayName: 'Set CGO_ENABLED for Windows'
        condition: eq(variables.type, 'windows')

      - bash: |
          # Install Node.js (v18 as an example)
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs

          # Install Azurite
          npm install -g azurite

          # Create a directory for Azurite data
          mkdir -p azurite

          # Run Azurite in background
          azurite --silent --location azurite --debug azurite/debug.log &
        displayName: 'Install and Run Azurite'

      # Running E2E Tests on AMD64
      - task: AzureCLI@2
        inputs:
          azureSubscription: azcopytestworkloadidentity
          addSpnToEnvironment: true
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            set -e

            # Create coverage directory
            mkdir -p ./coverage

            # Create log directory
            mkdir -p "${AZCOPY_E2E_LOG_OUTPUT}"

            echo "Building executable"

            # Set platform-specific variables
            tags=""
            suffix=""
            build_name=""
            display_name=""

            unameOut="$(uname -s)"
            case "${unameOut}" in
                Linux*)
                  export GOOS="linux"
                  export GOARCH="amd64"
                  tags="netgo"
                  build_name="azcopy_linux_amd64"
                  display_name="Linux"
                  ;;
                Darwin*)
                  export GOOS="darwin"
                  export GOARCH="amd64"
                  export CGO_ENABLED="1"
                  build_name="azcopy_darwin_amd64"
                  display_name="MacOS"
                  ;;
                CYGWIN*|MINGW*|MSYS*)
                  export GOOS="windows"
                  export GOARCH="amd64"
                  suffix=".exe"
                  build_name="azcopy_windows_amd64.exe"
                  display_name="Windows"
                  ;;
                *)
                  echo "Unsupported OS: ${unameOut}"
                  exit 1
                  ;;
            esac

            if [[ -n "$tags" ]]; then
              go build -cover -tags "$tags" -o "$build_name"
            else
              go build -cover -o "$build_name"
            fi

            echo "Running azcopy version"
            $build_name version
            echo "Hello, world!" > myfile.txt
            echo "Copying file to NFS share"
            $build_name copy "myfile.txt" "https://seancanaryfilepremium.file.core.windows.net/aznfs3?sv=2024-11-04&ss=f&srt=sco&sp=rwdlc&se=2026-04-15T14:04:04Z&st=2025-04-15T06:04:04Z&spr=https&sig=sliitsNJRVpDV8fqQa7R0ocvejcyxS%2BOygKHqdFBkB8%3D" --nfs
            echo "Copying successfully"
            echo "Running tests"
            go test -timeout=2h -v ${{ parameters.test_cli_param }} ./e2etest | tee test.txt
            exitCode=$?

            echo "Generating junit report"
            cat test.txt | "$(go env GOPATH)/bin/go-junit-report" > "${display_name}_report.xml"

            echo "Formatting coverage directory to legacy txt format"
            go tool covdata textfmt -i=coverage -o "${display_name}_coverage.txt"

            echo "Formatting coverage to json format"
            "$(go env GOPATH)/bin/gocov${suffix}" convert "${display_name}_coverage.txt" > "${display_name}_coverage.json"

            echo "Formatting coverage to xml format"
            cat "${display_name}_coverage.json" | "$(go env GOPATH)/bin/gocov-xml${suffix}" > "${display_name}_coverage.xml"

            exit $exitCode
        env:
#          AZCOPY_E2E_ACCOUNT_KEY: $(AZCOPY_E2E_ACCOUNT_KEY)
#          AZCOPY_E2E_ACCOUNT_NAME: $(AZCOPY_E2E_ACCOUNT_NAME)
#          AZCOPY_E2E_ACCOUNT_KEY_HNS: $(AZCOPY_E2E_ACCOUNT_KEY_HNS)
#          AZCOPY_E2E_ACCOUNT_NAME_HNS: $(AZCOPY_E2E_ACCOUNT_NAME_HNS)
#          AZCOPY_E2E_CLASSIC_ACCOUNT_NAME: $(AZCOPY_E2E_CLASSIC_ACCOUNT_NAME)
#          AZCOPY_E2E_CLASSIC_ACCOUNT_KEY: $(AZCOPY_E2E_CLASSIC_ACCOUNT_KEY)
          AZCOPY_E2E_LOG_OUTPUT: '$(System.DefaultWorkingDirectory)/logs'
#          AZCOPY_E2E_OAUTH_MANAGED_DISK_CONFIG: $(AZCOPY_E2E_OAUTH_MANAGED_DISK_CONFIG)
#          AZCOPY_E2E_OAUTH_MANAGED_DISK_SNAPSHOT_CONFIG: $(AZCOPY_E2E_OAUTH_MANAGED_DISK_SNAPSHOT_CONFIG)
#          AZCOPY_E2E_STD_MANAGED_DISK_CONFIG: $(AZCOPY_E2E_STD_MANAGED_DISK_CONFIG)
#          AZCOPY_E2E_STD_MANAGED_DISK_SNAPSHOT_CONFIG: $(AZCOPY_E2E_STD_MANAGED_DISK_SNAPSHOT_CONFIG)
#          CPK_ENCRYPTION_KEY: $(CPK_ENCRYPTION_KEY)
#          CPK_ENCRYPTION_KEY_SHA256: $(CPK_ENCRYPTION_KEY_SHA256)
          AZCOPY_E2E_EXECUTABLE_PATH: $(System.DefaultWorkingDirectory)/$(build_name)
          GOCOVERDIR: '$(System.DefaultWorkingDirectory)/coverage'
          #NEW_E2E_SUBSCRIPTION_ID: $(AZCOPY_NEW_E2E_SUBSCRIPTION_ID)
          NEW_E2E_AZCOPY_PATH: $(System.DefaultWorkingDirectory)/$(build_name)
          NEW_E2E_ENVIRONMENT: "AzurePipeline"
          RUN_NFS_TESTSUITE: "TRUE"
          NEW_E2E_PREMIUM_FILESHARE_ACCOUNT_KEY: $(AZCOPY_PREMIUM_FILESHARE_ACCOUNT_KEY)
          NEW_E2E_PREMIUM_FILESHARE_ACCOUNT_NAME: $(AZCOPY_PREMIUM_FILESHARE_ACCOUNT_NAME)
        displayName: 'E2E Test $(display_name) - AMD64 with Workload Identity'

      - task: PublishBuildArtifacts@1
        displayName: 'Publish logs'
        condition: succeededOrFailed()
        inputs:
          pathToPublish: '$(System.DefaultWorkingDirectory)/logs'
          artifactName: logs

      - task: PublishTestResults@2
        condition: succeededOrFailed()
        inputs:
          testRunner: JUnit
          testResultsFiles: $(System.DefaultWorkingDirectory)/**/$(display_name)_report.xml
          testRunTitle: 'Go on $(display_name)'

      - task: PublishCodeCoverageResults@1
        condition: succeededOrFailed()
        inputs:
          codeCoverageTool: Cobertura
          summaryFileLocation: $(System.DefaultWorkingDirectory)/**/$(display_name)_coverage.xml
          additionalCodeCoverageFiles: $(System.DefaultWorkingDirectory)/**/$(display_name)_coverage.html