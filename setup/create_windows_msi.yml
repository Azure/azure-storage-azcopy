parameters:
  working_dir: ''
  build_dir: ''
  azcopy_version: ''

steps:
- powershell: |
    # Check if Chocolatey is installed
    if (!(Get-Command choco.exe -ErrorAction SilentlyContinue)) {
        Write-Host "Chocolatey is not installed. Installing Chocolatey..."
        Set-ExecutionPolicy Bypass -Scope Process -Force; 
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; 
        Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
    } else {
        Write-Host "Chocolatey is already installed."
    }

    # Install WiX Toolset using Chocolatey
    Write-Host "Installing WiX Toolset via Chocolatey..."
    choco install wixtoolset -y
    Write-Host "WiX Toolset installation completed."
  displayName: 'Install Chocolatey and WiX Toolset'

- powershell: |
    # PowerShell Script to create MSI in an Azure Pipeline

    # Step 1: Set Variables
    $workDir = "${{ parameters.working_dir }}"
    $wixToolsPath = (where.exe candle.exe) -replace '\\candle.exe$', ''  # Remove candle.exe from path
    $wxsFilePath = "$workDir\azcopy.wxs"
    $wixObjPath = "$workDir\azcopy.wixobj"
    $outputMsi = "${{ parameters.build_dir }}\azcopy.msi"

    # Step 2: Update the fields in the .wxs file
    Write-Host "Updating Uuid in .wxs file..."
    $uuid = [guid]::NewGuid().Guid.ToString()

    # Load the XML file with namespace handling
    [xml]$wixXml = Get-Content $wxsFilePath

    # Define the XML namespace manager
    $namespaceManager = New-Object System.Xml.XmlNamespaceManager($wixXml.NameTable)
    $namespaceManager.AddNamespace("wix", "http://schemas.microsoft.com/wix/2006/wi")

    # Update fields using the namespace
    $productNode = $wixXml.SelectSingleNode("//wix:Product", $namespaceManager)
    $productNode.Name = "azcopy"
    $productNode.Version = "${{ parameters.build_dir }}"
    $productNode.Manufacturer = "Updated Manufacturer"
    $productNode.UpgradeCode = $uuid

    # Locate the Component node using the namespace
    $component = $wixXml.SelectSingleNode("//wix:Directory[@Id='INSTALLDIR']/wix:Component", $namespaceManager)

    # Check if Component element exists
    if ($component) {
        # Check if Guid attribute exists and set it, or add it if missing
        if ($component.Attributes["Guid"]) {
            $component.Attributes["Guid"].Value = $uuid
        } else {
            $component.SetAttribute("Guid", $uuid)
        }
        Write-Host "Guid attribute updated successfully."
    } else {
        Write-Host "Component element not found in XML structure."
    }

    # Update the file source path
    $file = $component.SelectSingleNode("wix:File", $namespaceManager)
    $file.Source = "$workDir\azcopy.exe" 

    # Save the updated XML back to the file
    $wixXml.Save($wxsFilePath)

    # Print the updated content of the .wxs file
    Write-Host "Updated content of the .wxs file:"
    Get-Content $wxsFilePath

    Write-Host "WiX XML file updated successfully."

    # Step 3: Compile the .wxs file using Candle
    Write-Host "Compiling .wxs file..."
    & "$wixToolsPath\candle.exe" -out $wixObjPath $wxsFilePath

    # Step 4: Link the .wixobj to create the MSI using Light
    Write-Host "Linking to create MSI..."
    & "$wixToolsPath\light.exe" -out $outputMsi $wixObjPath

    Write-Host "MSI creation process completed!"

    # Remove the azcopy.wixpdb file as it is not required.
    # .wixpdb file is a debugging file generated by WiX Toolset.
    Remove-Item -Path "$outputMsi\*.wixpdb" -Force

    # Step 5: Install the MSI and verify the installation
    Write-Host "Installing the MSI for verification ..."
    msiexec /i $outputMsi
    if ($LASTEXITCODE -eq 0) {
    Write-Host "Installation was successful."
    } else {
        Write-Host "Installation failed with exit code $LASTEXITCODE."
    }