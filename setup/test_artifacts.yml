parameters:
  - name: artifact_name
    type: string
  - name: download_path
    type: string
  - name: item_pattern
    type: string

variables:
  - name: root_dir
    value: '$(System.DefaultWorkingDirectory)'
  - name: work_dir
    value: '$(System.DefaultWorkingDirectory)/azure-storage-azcopy'

steps:
  #TODO: Remove this while merging to main
  # - script: |
  #     wget https://raw.githubusercontent.com/dphulkar-msft/azure-storage-azcopy/az-pipelineTest/go_installer.sh -P $(work_dir)/
  #     chmod 777 $(work_dir)/go_installer.sh
  #   displayName: 'List files after downloading go_installer.sh'

  - script: |
      git checkout `echo $(Build.SourceBranch) | cut -d "/" -f 1,2 --complement`
    displayName: 'Checkout Branch'
    workingDirectory: $(System.DefaultWorkingDirectory)/azure-storage-azcopy

  - task: ShellScript@2
    inputs:
      scriptPath: "$(System.DefaultWorkingDirectory)/azure-storage-azcopy/go_installer.sh"
      args: "$(System.DefaultWorkingDirectory)/"
    displayName: "GoTool Custom Setup"

  - task: DownloadBuildArtifacts@0
    displayName: 'Download Build Artifacts'
    inputs:
      artifactName: ${{ parameters.artifact_name }}
      downloadPath: ${{ parameters.download_path }}
      itemPattern: ${{ parameters.item_pattern }}

  - script: |
      ls -l
      result=$(ls -1 | wc -l)
      if [ $result -ne 1 ]; then
        exit 1
      fi
    displayName: 'List Downloaded Package'
    workingDirectory: ${{ parameters.download_path }}/${{ parameters.artifact_name }}
